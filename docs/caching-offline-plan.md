# Caching & Offline Strategy (Draft)

> 目标：提升移动端与 Web 在弱网 / 离线场景下的可用性，同时减少重复请求带来的延迟与成本。本草案先记录方向，后续迭代中逐步落地。

## 1. 需求背景

- 移动端目前完全依赖实时请求，离线或弱网下无法查看任务。  
- 任务、标签、通知等数据重复请求较多，可利用缓存降低延迟。  
- 后续计划增加附件/图片等较大资源，需要预取与上传队列。  
- 多端（Web + Mobile）需要统一的数据一致性方案。

## 2. 范围与优先级

1. **移动端任务 & 标签列表（高优）**  
   - 离线查看任务详情、状态、备注。  
   - 支持本地修改（完成、备注）→ 上传队列 → 成功后更新缓存。  
2. **Web 端仪表盘与列表（中优）**  
   - React Query / SWR 持久化缓存，减少重复查询。  
   - 配合 Supabase Realtime 实现增量刷新。  
3. **附件上传队列（后续）**  
   - 本地缓存待上传文件，网络恢复后自动上传。

## 3. 移动端缓存方案

### 3.1 技术栈
- 状态管理：现有 Zustand store，加入 `persist` 中间件。  
- 存储介质：`expo-secure-store`（敏感数据） + `MMKV` 或 `AsyncStorage`（普通缓存）。  
- 数据层：可整合 React Query 进行请求缓存与失效控制。

### 3.2 同步流程
1. App 启动 → 加载本地缓存 → 展示 UI。  
2. 后台发起增量请求：  
   - 使用 `updated_at` / `sync_token`，仅拉取最近改动。  
   - 如检测有新数据，合并到 store 并刷新 UI。  
3. 用户操作（更新任务、添加备注）：  
   - 先写入本地 pending 队列（含时间戳、操作类型）。  
   - 立即更新 UI。  
   - 后台调用 Supabase API，成功则从 pending 队列移除，失败则保留并提示重试。

### 3.3 离线状态提示
- 监听网络状态（`expo-network` / `NetInfo`），显示顶部 Banner。  
- 离线时隐藏上传按钮或提示“稍后同步”。  
- 提供“重试所有挂起操作”入口。

## 4. Web 缓存策略

1. 引入 React Query：  
   - 为任务、成员、标签等接口配置 `staleTime`。  
   - 使用 `queryClient.setQueryData` 与 Supabase Realtime 回调结合，实现局部刷新。  
2. 针对仪表盘数据：  
   - 允许短时间缓存（如 30s），减少频繁查询。  
   - 提供“手动刷新”按钮及刷新时间戳。  
3. 浏览器存储：  
   - 对部分数据（最近访问的任务、成员）启用 sessionStorage/localStorage。  
   - 清晰说明缓存目录，提供“清除缓存”入口以便调试。

## 5. 数据一致性与冲突处理

- **优先级**：服务器状态为真，客户端只缓存快照。  
- **冲突策略**：  
  1. 客户端提交 → 返回 409 / 412 时提示用户重新载入。  
  2. 可选地在 payload 中携带 `updated_at`，用 Supabase `eq(updated_at, ...)` 进行乐观锁。  
- **失败回退**：挂起操作如失败次数超过阈值，提示用户或允许放弃。

## 6. 后续行动

1. 原型验证：先在移动端任务列表实现 `Zustand persist + 增量同步`。  
2. 文档：记录数据结构、同步算法、错误状态枚举。  
3. 监控：对同步失败、队列长度等关键指标添加日志或告警。  
4. 迭代计划：结合 `docs/MVP-task-plan.md` 中的“移动端缓存与离线体验”任务逐步落地。

---

> 本草案用于指导后续实现，具体细节（如缓存格式、表结构调整）将在迭代中补充。***
